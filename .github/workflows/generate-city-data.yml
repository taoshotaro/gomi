name: Generate City Data

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      city:
        description: "City name in Japanese (e.g., 品川区)"
        required: true
      prefecture:
        description: "Prefecture in Japanese (e.g., 東京都)"
        required: true
      source_url:
        description: "Official garbage page URL (optional)"
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  generate:
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issues' && contains(github.event.label.name, 'ai-generate'))
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Parse issue body
        if: github.event_name == 'issues'
        id: parse
        run: |
          echo '${{ github.event.issue.body }}' > /tmp/issue-body.txt
          PARSED=$(bun run .github/scripts/parse-issue.ts /tmp/issue-body.txt)
          echo "city=$(echo $PARSED | jq -r '.city')" >> $GITHUB_OUTPUT
          echo "prefecture=$(echo $PARSED | jq -r '.prefecture')" >> $GITHUB_OUTPUT
          echo "source_url=$(echo $PARSED | jq -r '.source_url // empty')" >> $GITHUB_OUTPUT

      - name: Set inputs
        id: inputs
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "city=${{ steps.parse.outputs.city }}" >> $GITHUB_OUTPUT
            echo "prefecture=${{ steps.parse.outputs.prefecture }}" >> $GITHUB_OUTPUT
            echo "source_url=${{ steps.parse.outputs.source_url }}" >> $GITHUB_OUTPUT
          else
            echo "city=${{ inputs.city }}" >> $GITHUB_OUTPUT
            echo "prefecture=${{ inputs.prefecture }}" >> $GITHUB_OUTPUT
            echo "source_url=${{ inputs.source_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate data with LLM
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          MODEL: ${{ vars.MODEL }}
        run: |
          ARGS="--city '${{ steps.inputs.outputs.city }}' --prefecture '${{ steps.inputs.outputs.prefecture }}'"
          if [ -n "${{ steps.inputs.outputs.source_url }}" ]; then
            ARGS="$ARGS --url '${{ steps.inputs.outputs.source_url }}'"
          fi
          eval "bun run .github/scripts/generate.ts $ARGS"

      - name: Validate generated data
        run: bun run validate

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "data: add ${{ steps.inputs.outputs.city }} (${{ steps.inputs.outputs.prefecture }})"
          title: "data: add ${{ steps.inputs.outputs.city }} (${{ steps.inputs.outputs.prefecture }})"
          body: |
            ## Auto-generated garbage data

            - **City**: ${{ steps.inputs.outputs.city }}
            - **Prefecture**: ${{ steps.inputs.outputs.prefecture }}
            - **Source**: ${{ steps.inputs.outputs.source_url }}
            ${{ github.event_name == 'issues' && format('- **Issue**: #{0}', github.event.issue.number) || '' }}

            ### Review checklist
            - [ ] schedule.json: Collection days match official source
            - [ ] schedule.json: Area divisions are correct
            - [ ] separation.json: Categories match official source
            - [ ] separation.json: Items have accurate keywords
            - [ ] separation.json: Preparation instructions are correct

            ---
            Generated by AI. Please verify against the official municipal website.
          branch: "data/${{ steps.inputs.outputs.city }}"
          labels: |
            ai-generated
            data
