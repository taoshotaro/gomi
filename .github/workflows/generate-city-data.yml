name: Generate City Data

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      city:
        description: "City name in Japanese (e.g., 品川区)"
        required: true
      prefecture:
        description: "Prefecture in Japanese (e.g., 東京都)"
        required: true
      source_url:
        description: "Official garbage page URL (optional)"
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate:
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issues' && contains(github.event.label.name, 'ai-generate'))
    concurrency:
      group: >
        generate-city-${{ github.event_name == 'workflow_dispatch' &&
        format('{0}-{1}', inputs.prefecture, inputs.city) ||
        format('issue-{0}', github.event.issue.number) }}
      cancel-in-progress: false
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Parse issue body
        if: github.event_name == 'issues'
        id: parse
        run: |
          printf '%s' '${{ github.event.issue.body }}' > /tmp/issue-body.txt
          PARSED=$(bun run tools/generator/cli/parse-issue.ts /tmp/issue-body.txt)
          echo "city=$(jq -r '.city' <<< \"$PARSED\")" >> $GITHUB_OUTPUT
          echo "prefecture=$(jq -r '.prefecture' <<< \"$PARSED\")" >> $GITHUB_OUTPUT
          echo "source_url=$(jq -r '.source_url // empty' <<< \"$PARSED\")" >> $GITHUB_OUTPUT

      - name: Set inputs
        id: inputs
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "city=${{ steps.parse.outputs.city }}" >> $GITHUB_OUTPUT
            echo "prefecture=${{ steps.parse.outputs.prefecture }}" >> $GITHUB_OUTPUT
            echo "source_url=${{ steps.parse.outputs.source_url }}" >> $GITHUB_OUTPUT
          else
            echo "city=${{ inputs.city }}" >> $GITHUB_OUTPUT
            echo "prefecture=${{ inputs.prefecture }}" >> $GITHUB_OUTPUT
            echo "source_url=${{ inputs.source_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate data with LLM
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ vars.LLM_BASE_URL }}
          MODEL: ${{ vars.MODEL }}
        run: |
          if [ -n "${{ steps.inputs.outputs.source_url }}" ]; then
            bun run tools/generator/cli/generate-city.ts \
              --city "${{ steps.inputs.outputs.city }}" \
              --prefecture "${{ steps.inputs.outputs.prefecture }}" \
              --url "${{ steps.inputs.outputs.source_url }}" \
              --mode fast \
              --discover-max-steps 20 \
              --discover-max-rounds 2 \
              --discover-max-candidates 30 \
              --discover-max-fetches 20 \
              --discover-link-depth 1 \
              --max-total-ms 180000 \
              --max-step-ms 90000 \
              --max-model-ms 45000 \
              --selection-mode hybrid \
              --selection-top-k 3 \
              --selection-max-model-ms 12000 \
              --selection-confidence-threshold 0.7 \
              --selection-evidence-bytes 12000 \
              --html-cleanup-timeout-ms 45000 \
              --html-cleanup-required \
              --html-cleanup-failure-policy skip-source \
              --max-html-cleanup-calls 2 \
              --drift-threshold 0.2 \
              --model "${{ vars.MODEL || 'glm-4.7' }}" \
              --base-url "${{ vars.ANTHROPIC_BASE_URL || vars.LLM_BASE_URL || 'https://api.z.ai/api/anthropic/v1' }}" \
              --skills-mode hybrid \
              --strict-skills-compat
          else
            bun run tools/generator/cli/generate-city.ts \
              --city "${{ steps.inputs.outputs.city }}" \
              --prefecture "${{ steps.inputs.outputs.prefecture }}" \
              --mode fast \
              --discover-max-steps 20 \
              --discover-max-rounds 2 \
              --discover-max-candidates 30 \
              --discover-max-fetches 20 \
              --discover-link-depth 1 \
              --max-total-ms 180000 \
              --max-step-ms 90000 \
              --max-model-ms 45000 \
              --selection-mode hybrid \
              --selection-top-k 3 \
              --selection-max-model-ms 12000 \
              --selection-confidence-threshold 0.7 \
              --selection-evidence-bytes 12000 \
              --html-cleanup-timeout-ms 45000 \
              --html-cleanup-required \
              --html-cleanup-failure-policy skip-source \
              --max-html-cleanup-calls 2 \
              --drift-threshold 0.2 \
              --model "${{ vars.MODEL || 'glm-4.7' }}" \
              --base-url "${{ vars.ANTHROPIC_BASE_URL || vars.LLM_BASE_URL || 'https://api.z.ai/api/anthropic/v1' }}" \
              --skills-mode hybrid \
              --strict-skills-compat
          fi

      - name: Upload generator artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: generator-debug-${{ github.run_id }}
          path: |
            .tmp/generator-runs/**/events.jsonl
            .tmp/generator-runs/**/events.log
            .tmp/generator-runs/**/run-state.json
            .tmp/generator-runs/**/discover-report.json
            .tmp/generator-runs/**/discover-selected.json
            .tmp/generator-runs/**/source-manifest.json
            .tmp/generator-runs/**/extraction-plan.json
            .tmp/generator-runs/**/execution-report.json
            .tmp/generator-runs/**/cleanup-report.json
            .tmp/generator-runs/**/selection-report.json
            .tmp/generator-runs/**/conversion-plan.json
            .tmp/generator-runs/**/conversion-report.json
            /tmp/gomi-raw/**/events.jsonl
            /tmp/gomi-raw/**/events.log
            /tmp/gomi-raw/**/run-state.json
            /tmp/gomi-raw/**/discover-report.json
            /tmp/gomi-raw/**/discover-selected.json
            /tmp/gomi-raw/**/source-manifest.json
            /tmp/gomi-raw/**/extraction-plan.json
            /tmp/gomi-raw/**/execution-report.json
            /tmp/gomi-raw/**/cleanup-report.json
            /tmp/gomi-raw/**/selection-report.json
            /tmp/gomi-raw/**/conversion-plan.json
            /tmp/gomi-raw/**/conversion-report.json
          if-no-files-found: ignore

      - name: Validate generated data
        run: bun run validate

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "data: add ${{ steps.inputs.outputs.city }} (${{ steps.inputs.outputs.prefecture }})"
          title: "data: add ${{ steps.inputs.outputs.city }} (${{ steps.inputs.outputs.prefecture }})"
          body: |
            ## Auto-generated garbage data

            - **City**: ${{ steps.inputs.outputs.city }}
            - **Prefecture**: ${{ steps.inputs.outputs.prefecture }}
            - **Source**: ${{ steps.inputs.outputs.source_url }}
            ${{ github.event_name == 'issues' && format('- **Issue**: #{0}', github.event.issue.number) || '' }}

            ### Review checklist
            - [ ] schedule.json: Collection days match official source
            - [ ] schedule.json: Area divisions are correct
            - [ ] separation.json: Categories match official source
            - [ ] separation.json: Items have accurate keywords
            - [ ] separation.json: Preparation instructions are correct

            ---
            Generated by AI. Please verify against the official municipal website.
          branch: "data/${{ steps.inputs.outputs.city }}"
          labels: |
            ai-generated
            data

      - name: Notify on failure
        if: failure() && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Data generation failed. Check [workflow logs](' +
                    `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}` +
                    ') for details.\n\nYou can re-trigger by removing and re-adding the `ai-generate` label.'
            })
